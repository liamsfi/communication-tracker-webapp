<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Daily Mail</title>
  <style>
    /* Base styles */
    body {
      font-family: Arial, sans-serif;
      background-color: #f5f5f5; /* light grey background for entire page */
      color: #333;
      margin: 0;
      padding: 20px;
      line-height: 1.5;
    }
    /* Container to center content and add subtle shadow. Increase max width
       to provide a larger working area on wide screens. */
    .container {
      width: 90%;
      max-width: 1000px;
      margin: 0 auto;
      background-color: #ffffff;
      padding: 20px 24px;
      border: 1px solid #dcdcdc;
      border-radius: 6px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04);
    }
    h1 {
      color: #333;
      margin-top: 0;
      margin-bottom: 10px;
      font-size: 1.6em;
    }
    /* Form layout */
    form {
      /* Use a 4â€‘column grid so User, Category, Description and the button
         occupy equal widths. This ensures the entry fields and Add Entry
         button align perfectly and appear the same size. */
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
      align-items: flex-end;
      margin-bottom: 20px;
    }
    form > div {
      display: flex;
      flex-direction: column;
    }
    label {
      font-weight: 500;
      margin-bottom: 4px;
    }
    input, select {
      width: 100%;
      padding: 8px 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      box-sizing: border-box;
      background-color: #fff;
      color: #333;
      /* Set a fixed height so inputs, selects and the button align uniformly */
      height: 40px;
    }
    /* Style for contenteditable description input */
    .description-input {
      border: 1px solid #ddd;
      padding: 8px 10px;
      /* Match height of other fields */
      height: 40px;
      min-height: 40px;
      width: 100%;
      border-radius: 4px;
      box-sizing: border-box;
      background-color: #fff;
      overflow-y: auto;
      white-space: pre-wrap;
      color: #333;
    }
    /* Buttons */
    .button-row {
      margin-top: 10px;
      /* Ensure the button fills the full width of its grid cell */
      width: 100%;
    }
    button {
      /* Match padding and height of input fields for consistent sizing */
      padding: 8px 10px;
      height: 40px;
      border: none;
      border-radius: 4px;
      background-color: #555555; /* dark grey button */
      color: #ffffff;
      cursor: pointer;
      font-size: 0.85em;
      width: 100%;
    }
    button:hover {
      background-color: #333333;
    }
    /* Post list styles replacing table */
    .post-list {
      margin-top: 20px;
    }
    .post {
      border: 1px solid #dddddd;
      border-radius: 4px;
      padding: 10px 12px;
      margin-bottom: 12px;
      background-color: #ffffff;
    }
    .post-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.85em;
      color: #555;
      margin-bottom: 4px;
      gap: 8px;
    }
    .post-header .left-info {
      font-weight: 500;
    }
    .post-header .right-actions {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .post-header .meta {
      color: #888;
      font-size: 0.8em;
    }
    .post-header button {
      background: none;
      border: none;
      color: #555;
      font-size: 0.8em;
      cursor: pointer;
      padding: 0 4px;
    }
    .post-header button:hover {
      text-decoration: underline;
    }
    .post-body {
      margin-bottom: 8px;
      /* Smaller font size for update text so the box can be thinner */
      font-size: 0.85em;
      line-height: 1.4;
    }

    /* Styles for condensed previews shown when replies are collapsed */
    .original-preview,
    .reply-preview {
      font-size: 0.85em;
      line-height: 1.4;
      margin-bottom: 4px;
    }
    .reply-preview em {
      font-style: italic;
      color: #666;
    }
    .post-actions {
      margin-top: 4px;
    }
    .post-actions button {
      background-color: transparent;
      border: none;
      color: #2f5496;
      cursor: pointer;
      font-size: 0.85em;
      padding: 0;
    }
    .post-actions button:hover {
      text-decoration: underline;
    }
    .reply-form {
      margin-top: 8px;
    }
    .reply-form button {
      margin-right: 8px;
      margin-top: 4px;
    }
    /* Reply form styling */
    .reply-input {
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 6px;
      min-height: 40px;
      background-color: #fff;
      color: #333;
    }

    /* Authentication form styles */
    .auth-form {
      display: flex;
      flex-direction: column;
      gap: 8px;
      max-width: 300px;
      margin-bottom: 20px;
    }
    /* Remove default auth-form input/button rules â€“ we'll override with more
       polished login/register styling below. */
    .auth-form input {
      height: 40px;
      padding: 8px 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      box-sizing: border-box;
    }
    .auth-form button {
      height: 40px;
      background-color: #555555;
      color: #ffffff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .auth-form button:hover {
      background-color: #333333;
    }

    /* New login/register card styles inspired by modern signâ€‘in forms. */
    .auth-container {
      max-width: 420px;
      margin: 0 auto;
      background: #ffffff;
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: 30px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }
    .auth-container h2 {
      margin-top: 0;
      margin-bottom: 20px;
      font-size: 1.4em;
      text-align: center;
      color: #333;
    }
    .auth-form-v2 {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .auth-group {
      position: relative;
    }
    .auth-group i,
    .auth-group .icon {
      position: absolute;
      left: 10px;
      top: 50%;
      transform: translateY(-50%);
      color: #999999;
      font-size: 0.9em;
    }
    .auth-group input {
      width: 100%;
      padding: 10px 10px 10px 34px;
      border: 1px solid #ddd;
      border-radius: 4px;
      box-sizing: border-box;
      height: 40px;
      background-color: #fefefe;
      color: #333;
    }
    .auth-options {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.85em;
      color: #666;
    }
    .auth-options label {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .auth-options a {
      color: #007bff;
      text-decoration: none;
    }
    .auth-options a:hover {
      text-decoration: underline;
    }
    .auth-button {
      width: 100%;
      padding: 10px;
      border: none;
      border-radius: 4px;
      font-weight: 600;
      cursor: pointer;
      font-size: 0.95em;
    }
    .login-btn {
      background-color: #3897f0;
      color: #ffffff;
    }
    .login-btn:hover {
      background-color: #2d7fcc;
    }
    .register-btn {
      background-color: #f5f5f5;
      color: #333333;
      border: 1px solid #cccccc;
    }
    .register-btn:hover {
      background-color: #e5e5e5;
    }

    /* Style any HTML tables pasted into update descriptions to retain
       a simple grid appearance similar to Excel. This ensures tables
       remain legible when pasted from spreadsheets. */
    .post-body table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 4px;
      font-size: 0.85em;
    }
    .post-body th,
    .post-body td {
      border: 1px solid #ddd;
      padding: 4px 6px;
      text-align: left;
      vertical-align: top;
    }
    /* User management section spacing */
    #addUserSection {
      margin-top: 10px;
    }
    /* Buttons within user management section */
    #addUserBtn, #showAddUserBtn {
      margin-top: 8px;
    }
  </style>
  <!-- FontAwesome for icons in login/register forms -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-8Rj0ETaQAicT/Hg1yZmkhmp43s3Y4en9vyVfMMDAptVy9dUD3doJzFVJ0rq20J10l3nozs4xh2mMxC4WS/Hdag==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-firestore.js"></script>
</head>
  <body>
  <div class="container">
  <h1>Daily Mail</h1>
  <p>
    This lightweight web app allows you to maintain a structured log of your
    communication updates. To access your shared log across devices, please sign in or register. Your data will be saved in a cloud backend instead of the browser.
  </p>

  <!-- Authentication section -->
  <div id="authSection" class="auth-container">
    <!-- Login card -->
    <div id="loginCard" class="auth-card">
      <h2>Login</h2>
      <form id="loginForm" class="auth-form-v2">
        <div class="auth-group">
          <!-- Unicode envelope icon to avoid external dependencies -->
          <span class="icon">ðŸ“§</span>
          <input type="email" id="loginEmail" placeholder="Email Address" required />
        </div>
        <div class="auth-group">
          <!-- Unicode lock icon -->
          <span class="icon">ðŸ”’</span>
          <input type="password" id="loginPassword" placeholder="Password" required />
        </div>
        <div class="auth-options">
          <label><input type="checkbox" id="rememberMe" /> Remember Me</label>
          <a href="#" id="forgotPassword">Forgot Password?</a>
        </div>
        <button type="submit" class="auth-button login-btn">Login Now</button>
        <button type="button" class="auth-button register-btn" id="showRegister">Create Account</button>
      </form>
    </div>
    <!-- Register card -->
    <div id="registerCard" class="auth-card" style="display: none;">
      <h2>Create Account</h2>
      <form id="registerForm" class="auth-form-v2">
        <div class="auth-group">
          <!-- Unicode envelope icon to avoid external dependencies -->
          <span class="icon">ðŸ“§</span>
          <input type="email" id="registerEmail" placeholder="Email Address" required />
        </div>
        <div class="auth-group">
          <!-- Unicode lock icon -->
          <span class="icon">ðŸ”’</span>
          <input type="password" id="registerPassword" placeholder="Password" required />
        </div>
        <button type="submit" class="auth-button login-btn">Create Account</button>
        <button type="button" class="auth-button register-btn" id="showLogin">Back to Login</button>
      </form>
    </div>
  </div>

  <!-- Main app content shown only when authenticated -->
  <div id="appContent" style="display: none;">
    <button type="button" id="signOutBtn" style="float: right; margin-bottom: 10px;">Sign Out</button>
    <form id="entryForm">
      <!-- Hidden date field populated automatically -->
      <input type="hidden" id="date" />
      <div>
        <label for="user">User</label>
        <!-- Dropdown for selecting a user -->
        <select id="user" required></select>
      </div>
      <div>
        <label for="category">Category</label>
        <select id="category" required>
          <option value="RFQ">RFQ</option>
          <option value="Quote">Quote</option>
          <option value="PO">PO</option>
          <option value="ETA">ETA</option>
          <option value="Meeting">Meeting</option>
          <option value="Claim">Claim</option>
          <option value="Payment">Payment</option>
          <option value="Other">Other</option>
        </select>
      </div>
      <div>
        <label for="description">Description / Update</label>
        <!-- Use a contenteditable div so users can paste tables and keep formatting -->
        <div id="description" class="description-input" contenteditable="true"></div>
      </div>
      <div class="button-row">
        <button type="submit">Add Entry</button>
      </div>
    </form>

    <!-- Container for posts list -->
    <div id="logList" class="post-list"></div>

    <!-- User management section for adding new users -->
    <h2>User Management</h2>
    <p>Use this section to add new user initials to the list without creating an entry.</p>
    <button type="button" id="showAddUserBtn">Add New User</button>
    <div id="addUserSection" style="display: none;">
      <label for="newUser">User Initials</label>
      <input type="text" id="newUser" placeholder="e.g., LG" />
      <button type="button" id="addUserBtn">Add</button>
    </div>
  </div> <!-- end appContent -->
  </div> <!-- end container -->

  <script>
    // Initialize or load existing log from localStorage
    let commLog = [];

    // Track collapsed state of each entry's replies. Keys are entry ids and
    // values are booleans (true = collapsed). This is not persisted to local
    // storage; it only controls the UI during this session.
    const collapsedState = {};

    // --- Firebase configuration and initialization ---
    // Replace the placeholder values below with your project's actual Firebase
    // configuration. You can find this in your Firebase console under
    // Project settings > General > Your apps.
    // Configuration for the Daily Mail Firebase project.  These values
    // come from the Firebase console (Project settings > General > Your apps).
    const firebaseConfig = {
      apiKey: "AIzaSyCvIBy_UBSscYVJjEJIL6i_kKrIhTIqGKo",
      authDomain: "daily-mail-app.firebaseapp.com",
      projectId: "daily-mail-app",
      // Corrected storage bucket URL (.appspot.com) â€“ required for Firebase to
      // work properly. The previous value (.firebasestorage.app) caused
      // authentication issues and prevented login.
      storageBucket: "daily-mail-app.appspot.com",
      messagingSenderId: "842505249535",
      appId: "1:842505249535:web:7de48b88c09d15d176a2ca"
    };
    // Initialize Firebase app if the SDKs have loaded
    if (typeof firebase !== 'undefined' && !firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
    const auth = typeof firebase !== 'undefined' ? firebase.auth() : null;
    const db   = typeof firebase !== 'undefined' ? firebase.firestore() : null;

    // Manage list of users for the user dropdown
    let users = [];
    function loadUsers() {
      // Prefer 'users' key but fall back to 'persons' for backward compatibility
      let data = localStorage.getItem('users');
      if (!data) {
        data = localStorage.getItem('persons');
      }
      if (data) {
        try {
          users = JSON.parse(data);
        } catch (e) {
          users = [];
        }
      }
      // If no users stored or list is empty, use default initials
      if (!Array.isArray(users) || users.length === 0) {
        users = ['LG', 'MJ', 'TW', 'JY'];
      }
      renderUserOptions();
    }
    function saveUsers() {
      localStorage.setItem('users', JSON.stringify(users));
    }
    function renderUserOptions() {
      const select = document.getElementById('user');
      if (!select) return;
      const current = select.value;
      select.innerHTML = '';
      users.forEach(u => {
        const opt = document.createElement('option');
        opt.value = u;
        opt.textContent = u;
        select.appendChild(opt);
      });
      // Restore selection if it still exists in the list
      if (current && users.includes(current)) {
        select.value = current;
      } else {
        select.value = '';
      }
    }

    async function loadLog() {
      // If using Firebase, load entries from Firestore. Otherwise fall back to localStorage.
      if (db && auth && auth.currentUser) {
        commLog = [];
        try {
          const snapshot = await db.collection('entries').orderBy('date', 'desc').get();
          snapshot.forEach(doc => {
            const data = doc.data();
            // Firestore stores timestamps as Firebase Timestamp objects. Convert to ISO date string if necessary.
            if (data.date && data.date.toDate) {
              data.date = data.date.toDate().toISOString().split('T')[0];
            }
            ensureEntryShape(data);
            commLog.push({ ...data, id: doc.id });
          });
        } catch (err) {
          console.error('Error loading entries from Firestore:', err);
        }
        renderPosts();
        return;
      }
      // Local fallback when not authenticated
      const data = localStorage.getItem('comm_log');
      if (data) {
        try {
          commLog = JSON.parse(data);
        } catch (e) {
          console.error('Failed to parse log from localStorage', e);
          commLog = [];
        }
      } else {
        commLog = [];
      }
      commLog.forEach(entry => ensureEntryShape(entry));
      renderPosts();
    }

    function saveLog() {
      // When authenticated, entries are saved to Firestore individually on create/update.
      // For offline use or unauthenticated sessions, continue to save to localStorage.
      localStorage.setItem('comm_log', JSON.stringify(commLog));
    }

    /**
     * Recursively ensure that an entry (and all nested responses) has an id and a responses array.
     * This is important when loading old logs from localStorage that may not include these fields.
     */
    function ensureEntryShape(entry) {
      // Assign a unique id if missing. Fall back to any existing reference as id for backwards compatibility.
      if (!entry.id) {
        entry.id = (entry.reference || Date.now().toString()) + Math.random().toString(36).substr(2, 9);
      }
      // Normalize person/user field (older logs may store 'user' instead of 'person')
      if (!entry.person && entry.user) {
        entry.person = entry.user;
      }
      // Ensure responses array exists
      if (!Array.isArray(entry.responses)) {
        entry.responses = [];
      }
      // Recursively ensure shape on nested responses
      entry.responses.forEach(child => ensureEntryShape(child));
    }

    // Render posts list in a Reddit-style feed with nested replies
    function renderPosts() {
      const container = document.getElementById('logList');
      if (!container) return;
      container.innerHTML = '';
      const sortedEntries = commLog.slice().sort((a, b) => new Date(b.date) - new Date(a.date));
      sortedEntries.forEach(entry => {
        // Default to collapsed state on initial render if not previously set
        if (collapsedState[entry.id] === undefined) {
          collapsedState[entry.id] = true;
        }
        renderPost(entry, 0, container);
      });
    }

    function renderPost(entry, level, container) {
      if (!Array.isArray(entry.responses)) {
        entry.responses = [];
      }
      const postDiv = document.createElement('div');
      postDiv.className = 'post';
      postDiv.style.marginLeft = (level * 20) + 'px';
      postDiv.dataset.id = entry.id;
      // Apply Redditâ€‘style visual cues for nested replies: alternate background shades
      // and a subtle left border to connect comment threads. Deeper levels cycle
      // through a palette of light neutral colors to aid visual separation.
      const shades = ['#ffffff', '#fafafa', '#f5f5f5', '#f0f0f0'];
      postDiv.style.backgroundColor = shades[level % shades.length];
      if (level > 0) {
        postDiv.style.borderLeft = '3px solid #e0e0e0';
        postDiv.style.paddingLeft = '12px';
      }
      const headerDiv = document.createElement('div');
      headerDiv.className = 'post-header';
      // Left side: user and category
      const leftInfo = document.createElement('div');
      leftInfo.className = 'left-info';
      leftInfo.textContent = `${entry.person} - ${entry.category}`;
      // Right side: meta (date) and action buttons
      const rightActions = document.createElement('div');
      rightActions.className = 'right-actions';
      // Date meta
      const metaSpan = document.createElement('span');
      metaSpan.className = 'meta';
      metaSpan.textContent = entry.date;
      rightActions.appendChild(metaSpan);
      // If this entry has children, add a collapse toggle
      let toggleBtn = null;
      if (entry.responses && entry.responses.length > 0) {
        toggleBtn = document.createElement('button');
        toggleBtn.setAttribute('data-action', 'toggle-children');
        toggleBtn.setAttribute('data-id', entry.id);
        const isCollapsed = collapsedState[entry.id];
        const count = entry.responses.length;
        toggleBtn.textContent = isCollapsed ? `Show replies (${count})` : `Hide replies (${count})`;
        rightActions.appendChild(toggleBtn);
      }
      // Reply button
      const replyBtn = document.createElement('button');
      replyBtn.setAttribute('data-action', 'reply');
      replyBtn.setAttribute('data-id', entry.id);
      replyBtn.textContent = 'Reply';
      rightActions.appendChild(replyBtn);
      headerDiv.appendChild(leftInfo);
      headerDiv.appendChild(rightActions);
      postDiv.appendChild(headerDiv);
      const bodyDiv = document.createElement('div');
      bodyDiv.className = 'post-body';
      // If this is a top-level post and it is currently collapsed, show a condensed
      // preview of the original message and the latest reply instead of the full
      // conversation. Otherwise, display the full description.
      const isTopLevel = level === 0;
      const isCollapsed = collapsedState[entry.id];
      if (isTopLevel && isCollapsed) {
        // Helper to strip HTML tags to plain text for preview
        const stripHtml = function (html) {
          const tmp = document.createElement('div');
          tmp.innerHTML = html;
          return (tmp.textContent || tmp.innerText || '').trim();
        };
        const originalText = stripHtml(entry.description);
        // Trim the original message for preview (around 80 chars)
        const trimmedOriginal = originalText.length > 80 ? originalText.slice(0, 80) + 'â€¦' : originalText;
        // Build preview HTML
        let previewHtml = '';
        if (trimmedOriginal) {
          previewHtml += `<div class="original-preview">${trimmedOriginal}</div>`;
        }
        // Show the most recent reply preview if available
        if (entry.responses && entry.responses.length > 0) {
          // Get the last response in the immediate responses array (not deeply nested)
          const lastResponse = entry.responses[entry.responses.length - 1];
          const replyText = stripHtml(lastResponse.description);
          const trimmedReply = replyText.length > 100 ? replyText.slice(0, 100) + 'â€¦' : replyText;
          previewHtml += `<div class="reply-preview"><em>Latest update:</em> ${trimmedReply}</div>`;
        }
        bodyDiv.innerHTML = previewHtml;
      } else {
        // Full description for non-collapsed or nested posts
        bodyDiv.innerHTML = entry.description;
      }
      postDiv.appendChild(bodyDiv);
      // Reply form for this entry (hidden by default)
      const replyForm = document.createElement('div');
      replyForm.className = 'reply-form';
      replyForm.style.display = 'none';
      replyForm.setAttribute('data-parent-id', entry.id);
      const replyInput = document.createElement('div');
      replyInput.setAttribute('contenteditable', 'true');
      replyInput.className = 'reply-input';
      replyForm.appendChild(replyInput);
      const saveBtn = document.createElement('button');
      saveBtn.setAttribute('data-action', 'save-reply');
      saveBtn.setAttribute('data-parent-id', entry.id);
      saveBtn.textContent = 'Save';
      const cancelBtn = document.createElement('button');
      cancelBtn.setAttribute('data-action', 'cancel-reply');
      cancelBtn.setAttribute('data-parent-id', entry.id);
      cancelBtn.textContent = 'Cancel';
      replyForm.appendChild(saveBtn);
      replyForm.appendChild(cancelBtn);
      postDiv.appendChild(replyForm);
      container.appendChild(postDiv);
      // Recursively render children unless collapsed
      const isCollapsedChildren = collapsedState[entry.id];
      if (!isCollapsedChildren) {
        entry.responses.forEach(child => {
          renderPost(child, level + 1, container);
        });
      }
    }



    /**
     * Recursively find an entry or response by its id within a list of entries.
     * @param {Array} entries - List of entries to search
     * @param {string} id - The id of the entry to find
     * @returns {Object|null} The matching entry or null if not found
     */
    function findEntryById(entries, id) {
      for (const entry of entries) {
        if (entry.id === id) {
          return entry;
        }
        if (entry.responses && entry.responses.length) {
          const found = findEntryById(entry.responses, id);
          if (found) return found;
        }
      }
      return null;
    }

    document.getElementById('entryForm').addEventListener('submit', async function (e) {
      e.preventDefault();
      // Determine the selected user from the dropdown
      const userSelect = document.getElementById('user');
      let userVal = userSelect.value;
      const descDivVal = document.getElementById('description').innerText || document.getElementById('description').textContent;
      if (!descDivVal.trim()) {
        alert('Please enter a description/update.');
        return;
      }
      const entry = {
        date: document.getElementById('date').value,
        person: userVal,
        category: document.getElementById('category').value,
        id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
        description: document.getElementById('description').innerHTML.trim(),
        responses: []
      };
      if (db && auth && auth.currentUser) {
        // Save to Firestore
        try {
          await db.collection('entries').add(entry);
          await loadLog();
        } catch (err) {
          console.error('Error adding entry to Firestore:', err);
          alert('Failed to add entry to backend. It will be stored locally.');
          commLog.push(entry);
          saveLog();
          renderPosts();
        }
      } else {
        // Save locally when not authenticated
        commLog.push(entry);
        saveLog();
        renderPosts();
      }
      // Reset form and inputs
      this.reset();
      const dateAfterReset = document.getElementById('date');
      if (dateAfterReset) {
        dateAfterReset.value = new Date().toISOString().split('T')[0];
      }
      const descDiv = document.getElementById('description');
      if (descDiv) {
        descDiv.innerHTML = '';
      }
      renderUserOptions();
    });


    // Initialize on load and set up paste handler for bulk import
    document.addEventListener('DOMContentLoaded', function () {
      // Load user list; log entries will be loaded upon authentication
      loadUsers();

      // Automatically set the date field to today's date on page load
      const dateInput = document.getElementById('date');
      if (dateInput) {
        const today = new Date().toISOString().split('T')[0];
        dateInput.value = today;
      }

      // Set up user management UI
      const showAddUserBtn = document.getElementById('showAddUserBtn');
      const addUserSection = document.getElementById('addUserSection');
      const addUserBtn = document.getElementById('addUserBtn');
      const newUserInput = document.getElementById('newUser');

      if (showAddUserBtn) {
        showAddUserBtn.addEventListener('click', function () {
          // Toggle visibility of the add user section when button is clicked
          if (addUserSection.style.display === 'none' || addUserSection.style.display === '') {
            addUserSection.style.display = '';
            if (newUserInput) newUserInput.focus();
          } else {
            addUserSection.style.display = 'none';
          }
        });
      }
      if (addUserBtn) {
        addUserBtn.addEventListener('click', function () {
          const val = newUserInput ? newUserInput.value.trim() : '';
          if (val) {
            if (!users.includes(val)) {
              users.push(val);
              saveUsers();
            }
            if (newUserInput) newUserInput.value = '';
            if (addUserSection) addUserSection.style.display = 'none';
            renderUserOptions();
          }
        });
      }

      // Set up paste handler for the description box to preserve formatting when pasting tables
      const descriptionDiv = document.getElementById('description');
      if (descriptionDiv) {
        descriptionDiv.addEventListener('paste', function (e) {
          e.preventDefault();
          // Try to get HTML and plain text from clipboard
          const clipboardData = e.clipboardData || window.clipboardData;
          const htmlData = clipboardData.getData('text/html') || '';
          const textData = clipboardData.getData('text/plain') || '';
          // Display the pasted content, preserving table formatting if HTML is available
          if (htmlData) {
            descriptionDiv.innerHTML = htmlData;
          } else {
            descriptionDiv.textContent = textData;
          }
        });
      }

      // Toggle between login and register cards. The login card is shown by default.
      const loginCard   = document.getElementById('loginCard');
      const registerCard = document.getElementById('registerCard');
      const showRegisterBtn = document.getElementById('showRegister');
      const showLoginBtn   = document.getElementById('showLogin');
      if (showRegisterBtn) {
        showRegisterBtn.addEventListener('click', function () {
          if (loginCard && registerCard) {
            loginCard.style.display = 'none';
            registerCard.style.display = '';
          }
        });
      }
      if (showLoginBtn) {
        showLoginBtn.addEventListener('click', function () {
          if (loginCard && registerCard) {
            registerCard.style.display = 'none';
            loginCard.style.display = '';
          }
        });
      }

      // Set up reply and collapse handling on the post list. Use event
      // delegation to handle Reply, Save, Cancel and toggle actions for
      // both entries and nested responses.
      const postListEl = document.getElementById('logList');
      if (postListEl) {
        postListEl.addEventListener('click', function (event) {
          const action = event.target.dataset.action;
          if (!action) return;
          if (action === 'reply') {
            const id = event.target.dataset.id;
            const replyForm = this.querySelector(`.reply-form[data-parent-id='${id}']`);
            if (replyForm) {
              const isHidden = replyForm.style.display === 'none' || replyForm.style.display === '';
              replyForm.style.display = isHidden ? '' : 'none';
              const input = replyForm.querySelector('.reply-input');
              if (replyForm.style.display === '' && input) {
                input.focus();
              } else if (input) {
                input.innerHTML = '';
              }
            }
          } else if (action === 'save-reply') {
            const parentId = event.target.dataset.parentId;
            const replyForm = this.querySelector(`.reply-form[data-parent-id='${parentId}']`);
            if (!replyForm) return;
            const input = replyForm.querySelector('.reply-input');
            const content = input ? input.innerHTML.trim() : '';
            if (!content) {
              alert('Please enter a response.');
              return;
            }
            const userVal = document.getElementById('user').value;
            const parentEntry = findEntryById(commLog, parentId);
            const category = parentEntry ? parentEntry.category : 'Response';
            const newResponse = {
              id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
              date: new Date().toISOString().split('T')[0],
              person: userVal,
              category: category,
              description: content,
              responses: []
            };
            // Save response to Firestore if authenticated; otherwise update local data
            if (db && auth && auth.currentUser) {
              (async () => {
                try {
                  await db.collection('entries').doc(parentId).update({
                    responses: firebase.firestore.FieldValue.arrayUnion(newResponse)
                  });
                  await loadLog();
                } catch (err) {
                  console.error('Error saving response to Firestore:', err);
                  // Fallback to local update
                  if (parentEntry) {
                    if (!Array.isArray(parentEntry.responses)) parentEntry.responses = [];
                    parentEntry.responses.push(newResponse);
                  }
                  saveLog();
                  renderPosts();
                }
              })();
            } else {
              if (parentEntry) {
                if (!Array.isArray(parentEntry.responses)) parentEntry.responses = [];
                parentEntry.responses.push(newResponse);
              }
              saveLog();
              renderPosts();
            }
          } else if (action === 'cancel-reply') {
            const parentId = event.target.dataset.parentId;
            const replyForm = this.querySelector(`.reply-form[data-parent-id='${parentId}']`);
            if (!replyForm) return;
            replyForm.style.display = 'none';
            const input = replyForm.querySelector('.reply-input');
            if (input) input.innerHTML = '';
          } else if (action === 'toggle-children') {
            const id = event.target.dataset.id;
            // Toggle collapsed state for this entry's children
            collapsedState[id] = !collapsedState[id];
            renderPosts();
          }
        });
      }

      // --- Authentication handlers ---
      const loginForm = document.getElementById('loginForm');
      const registerForm = document.getElementById('registerForm');
      const signOutBtn = document.getElementById('signOutBtn');
      const authSection = document.getElementById('authSection');
      const appContent = document.getElementById('appContent');

      if (loginForm && auth) {
        loginForm.addEventListener('submit', function (e) {
          e.preventDefault();
          const email = document.getElementById('loginEmail').value;
          const password = document.getElementById('loginPassword').value;
          auth.signInWithEmailAndPassword(email, password)
            .catch(err => {
              alert(err.message);
            });
        });
      }
      if (registerForm && auth) {
        registerForm.addEventListener('submit', function (e) {
          e.preventDefault();
          const email = document.getElementById('registerEmail').value;
          const password = document.getElementById('registerPassword').value;
          auth.createUserWithEmailAndPassword(email, password)
            .catch(err => {
              alert(err.message);
            });
        });
      }
      if (signOutBtn && auth) {
        signOutBtn.addEventListener('click', function () {
          auth.signOut().catch(err => alert(err.message));
        });
      }
      // Monitor authentication state and toggle UI sections accordingly
      if (auth) {
        auth.onAuthStateChanged(function (user) {
          if (user) {
            // Hide auth forms and show app content
            if (authSection) authSection.style.display = 'none';
            if (appContent) appContent.style.display = '';
            loadLog();
          } else {
            // No user logged in; show auth forms and hide app content
            if (authSection) authSection.style.display = '';
            if (appContent) appContent.style.display = 'none';
          }
        });
      }
    });
  </script>
</body>
</html>
